<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>今日進度 + 人生900格</title>
  <style>
    :root { color-scheme: light dark; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Microsoft JhengHei", Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.5;
      padding: 24px;
      background: Canvas;
      color: CanvasText;
    }

    .container { max-width: 760px; margin: 0 auto; }

    h1, h2 { margin: 0 0 10px; line-height: 1.2; }
    h1 { font-size: 22px; }
    h2 { font-size: 20px; margin-top: 28px; }

    #now { opacity: .8; margin-bottom: 8px; }

    .percent {
      font-variant-numeric: tabular-nums;
      font-size: 40px;
      font-weight: 800;
      margin: 8px 0 16px;
    }

    .progress { height: 12px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
    @media (prefers-color-scheme: dark) {
      .progress { background: #2b2f36; }
    }
    .fill { height: 100%; width: 0%; background: linear-gradient(90deg, #4f46e5, #06b6d4); transition: width .2s linear; }
    .legend { display: flex; justify-content: space-between; font-size: 12px; opacity: .8; margin-top: 6px; font-variant-numeric: tabular-nums; }
    .note { font-size: 12px; opacity: .7; margin-top: 8px; }

    /* 人生 900 格 */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 16px;
      align-items: center;
      margin: 10px 0 8px;
    }
    .controls label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    .controls input[type="date"],
    .controls input[type="number"] {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid color-mix(in srgb, CanvasText 20%, transparent);
      background: Canvas;
      color: CanvasText;
      font: inherit;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px 12px;
      font-size: 14px;
      margin: 8px 0 10px;
    }
    .stats strong { font-variant-numeric: tabular-nums; }

    .life-grid {
      --cell: 14px;         /* 每格邊長 */
      --gap: 4px;           /* 格子間距 */
      --future: #e5e7eb;    /* 未來色 */
      --past:   #22c55e;    /* 已過色 */
      --current:#f59e0b;    /* 當月色 */
      display: grid;
      grid-template-columns: repeat(30, var(--cell));
      grid-auto-rows: var(--cell);
      gap: var(--gap);
      align-content: start;
      user-select: none;
      
      /* 置中設定 */
      margin: 0 auto;
      width: fit-content;
    }
    @media (prefers-color-scheme: dark) {
      .life-grid { --future:#2b2f36; }
    }
    .cell {
      width: var(--cell);
      height: var(--cell);
      border-radius: 3px;
      background: var(--future);
      position: relative;
      box-shadow: inset 0 0 0 1px color-mix(in srgb, CanvasText 12%, transparent);
    }
    .cell.past {
      background: var(--past);
      box-shadow: none;
    }
    .cell.current {
      outline: 1px dashed color-mix(in srgb, CanvasText 30%, transparent);
      outline-offset: -2px;
      background:
        linear-gradient(to right, var(--current) 0 0) no-repeat,
        var(--future);
      background-size: 0% 100%; /* 由 JS 設定為當月進度% */
      box-shadow: inset 0 0 0 1px color-mix(in srgb, CanvasText 12%, transparent);
    }
    .legend-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      font-size: 12px;
      opacity: .8;
      justify-content: center; /* 圖例也置中 */
    }
    .legend-item { display: inline-flex; align-items: center; gap: 6px; }
    .dot { width: 12px; height: 12px; border-radius: 3px; background: var(--future); box-shadow: inset 0 0 0 1px color-mix(in srgb, CanvasText 12%, transparent); }
    .dot.past { background: #22c55e; box-shadow: none; }
    .dot.current { background: linear-gradient(to right, #f59e0b 60%, var(--future) 0), var(--future); outline: 1px dashed color-mix(in srgb, CanvasText 30%, transparent); outline-offset: -2px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>今天已經過了多少時間？</h1>
    <div id="now">—</div>
    <div class="percent" id="percent">0%</div>

    <div class="progress" role="progressbar" aria-label="今日進度" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" id="progress">
      <div class="fill" id="fill"></div>
    </div>
    <div class="legend">
      <span id="start">00:00</span>
      <span id="end">24:00</span>
    </div>
    <div class="note">以你的本地時區計算（從今日凌晨到下一次凌晨；自動處理夏令時間）</div>

    <h2>人生 900 格（每月一格）</h2>
    <div class="controls" aria-label="設定">
      <label>生日
        <input id="birth" type="date" placeholder="YYYY-MM-DD">
      </label>
      <label>期望壽命（歲）
        <input id="expect" type="number" min="1" max="120" step="1" value="75">
      </label>
    </div>

    <div class="stats">
      <div>年齡：<strong id="age">—</strong></div>
      <div>已過月份：<strong id="monthsDone">—</strong></div>
      <div>人生進度：<strong id="lifePct">—</strong></div>
      <div>剩餘格數：<strong id="monthsLeft">—</strong></div>
    </div>

    <div id="lifeGrid" class="life-grid" role="img" aria-label="人生每月格子視覺化（每格代表一個月）"></div>
    <div class="legend-row">
      <span class="legend-item"><span class="dot past"></span>已過月份</span>
      <span class="legend-item"><span class="dot current"></span>當月（填充比例＝本月已過天數）</span>
      <span class="legend-item"><span class="dot"></span>未來月份</span>
    </div>
    <div class="note">小提醒：這只是視覺化工具，壽命可自行調整，請善用當下 ✨</div>
  </div>

  <script>
  (() => {
    // ===== 今日進度 =====
    const nowEl = document.getElementById('now');
    const percentEl = document.getElementById('percent');
    const fillEl = document.getElementById('fill');
    const progressEl = document.getElementById('progress');
    const startEl = document.getElementById('start');
    const endEl = document.getElementById('end');

    const dateFmt = new Intl.DateTimeFormat(undefined, { dateStyle: 'full', timeStyle: 'medium' });
    const timeFmt = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' });

    function startOfDay(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function startOfNextDay(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate() + 1); }

    function updateDayProgress() {
      const now = new Date();
      const start = startOfDay(now);
      const next = startOfNextDay(now);

      const elapsed = now - start;
      const total = next - start; // 可能非 24 小時（DST）
      const pct = Math.min(100, Math.max(0, (elapsed / total) * 100));

      nowEl.textContent = dateFmt.format(now);
      percentEl.textContent = pct.toFixed(2) + '%';
      fillEl.style.width = pct + '%';
      progressEl.setAttribute('aria-valuenow', pct.toFixed(2));
      startEl.textContent = timeFmt.format(start);
      endEl.textContent = timeFmt.format(next);
    }

    updateDayProgress();
    const dayTimer = setInterval(updateDayProgress, 200);
    window.addEventListener('beforeunload', () => clearInterval(dayTimer));

    // ===== 人生 900 格 =====
    const birthInput = document.getElementById('birth');
    const expectInput = document.getElementById('expect');
    const gridEl = document.getElementById('lifeGrid');

    const ageEl = document.getElementById('age');
    const monthsDoneEl = document.getElementById('monthsDone');
    const lifePctEl = document.getElementById('lifePct');
    const monthsLeftEl = document.getElementById('monthsLeft');

    let builtCells = 0;       // 目前格子數
    let cachedBirth = null;   // 已建格時的生日
    let titleCache = [];      // 每格 title cache（工具提示）
    const monthFmt = new Intl.DateTimeFormat(undefined, { year: 'numeric', month: '2-digit' });

    function clamp(n, a, b) { return Math.min(b, Math.max(a, n)); }

    function parseBirth() {
      const v = birthInput.value?.trim();
      if (!v) return null;
      const d = new Date(v);
      return isNaN(d) ? null : d;
    }

    function addMonthsClamped(date, n) {
      const y = date.getFullYear();
      const m = date.getMonth();
      const d = date.getDate();
      // 目標月份的第一天
      const first = new Date(y, m + n, 1);
      // 該月份天數
      const daysInTarget = new Date(y, m + n + 1, 0).getDate();
      const day = Math.min(d, daysInTarget);
      return new Date(y, m + n, day);
    }

    function monthsCompletedSince(birth, now) {
      if (now < birth) return 0;
      const raw = (now.getFullYear() - birth.getFullYear()) * 12 + (now.getMonth() - birth.getMonth());
      const anchor = addMonthsClamped(birth, raw);
      return now >= anchor ? raw : raw - 1;
    }

    function monthFractionSince(anchorStart, now) {
      const next = addMonthsClamped(anchorStart, 1);
      const span = next - anchorStart;
      if (span <= 0) return 1;
      return clamp((now - anchorStart) / span, 0, 1);
    }

    function buildGrid(totalMonths, birth) {
      gridEl.innerHTML = '';
      titleCache = [];
      builtCells = totalMonths;

      // 30 列 -> 最多接近 30x30（900 格）
      // 小於 30 的就自動少一些列
      gridEl.style.gridTemplateColumns = `repeat(30, var(--cell))`;

      const frag = document.createDocumentFragment();
      for (let i = 0; i < totalMonths; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        // 提示：第幾格 + 對應的年月（以生日當月為第 1 格）
        let title = `第 ${i + 1} 格`;
        if (birth) {
          const d = addMonthsClamped(birth, i);
          title += ` · ${monthFmt.format(d)}`;
        }
        cell.title = title;
        titleCache.push(title);
        frag.appendChild(cell);
      }
      gridEl.appendChild(frag);
    }

    function formatAge(birth, now) {
      if (!birth) return '—';
      if (now < birth) return '生日在未來';
      let y = now.getFullYear() - birth.getFullYear();
      let m = now.getMonth() - birth.getMonth();
      let d = now.getDate() - birth.getDate();
      if (d < 0) {
        // 借前一個月的天數
        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
        d += lastMonthEnd.getDate();
        m -= 1;
      }
      if (m < 0) {
        m += 12;
        y -= 1;
      }
      return `${y} 歲 ${m} 個月 ${d} 天`;
    }

    function updateLife(forceRebuild = false) {
      const now = new Date();
      const birth = parseBirth();
      const expectYears = clamp(parseInt(expectInput.value || '75', 10) || 75, 1, 120);
      const totalMonths = expectYears * 12;

      // 若未建格或壽命/生日變動則重建格子
      if (forceRebuild || builtCells !== totalMonths || (birth?.toDateString() !== cachedBirth?.toDateString())) {
        buildGrid(totalMonths, birth);
        cachedBirth = birth ? new Date(birth) : null;
      }

      // 沒有生日就只顯示空格與提示
      if (!birth) {
        ageEl.textContent = '—';
        monthsDoneEl.textContent = `— / ${totalMonths}`;
        lifePctEl.textContent = '—';
        monthsLeftEl.textContent = '—';
        return;
      }

      const mCompleted = monthsCompletedSince(birth, now); // 完整走過的月份（整數）
      const idxCurrent = clamp(mCompleted, 0, totalMonths); // 當月索引（可能等於 totalMonths）
      const startCurrent = addMonthsClamped(birth, idxCurrent);
      const frac = (idxCurrent >= totalMonths) ? 1 : monthFractionSince(startCurrent, now);

      // 更新格子狀態
      const cells = gridEl.children;
      for (let i = 0; i < cells.length; i++) {
        const c = cells[i];
        if (i < mCompleted) {
          if (!c.classList.contains('past')) c.className = 'cell past';
          c.style.backgroundSize = ''; // 非當月
          c.removeAttribute('aria-current');
        } else if (i === idxCurrent && idxCurrent < totalMonths) {
          c.className = 'cell current';
          c.style.backgroundSize = (frac * 100).toFixed(2) + '% 100%';
          c.setAttribute('aria-current', 'true');
        } else {
          c.className = 'cell';
          c.style.backgroundSize = '';
          c.removeAttribute('aria-current');
        }
      }

      // 統計資訊
      const monthsLivedDecimal = Math.min(totalMonths, mCompleted + (idxCurrent < totalMonths ? frac : 0));
      const lifePct = (monthsLivedDecimal / totalMonths) * 100;
      const monthsLeft = Math.max(0, totalMonths - Math.ceil(monthsLivedDecimal));

      ageEl.textContent = formatAge(birth, now);
      monthsDoneEl.textContent = `${mCompleted} / ${totalMonths}`;
      lifePctEl.textContent = lifePct.toFixed(2) + '%';
      monthsLeftEl.textContent = `${monthsLeft}`;
    }

    // 儲存/載入設定
    const LS = {
      birth: 'life.birth',
      expect: 'life.expect'
    };
    function loadSettings() {
      try {
        const b = localStorage.getItem(LS.birth);
        const e = localStorage.getItem(LS.expect);
        if (b) birthInput.value = b;
        if (e) expectInput.value = e;
      } catch {}
    }
    function saveSettings() {
      try {
        if (birthInput.value) localStorage.setItem(LS.birth, birthInput.value);
        if (expectInput.value) localStorage.setItem(LS.expect, expectInput.value);
      } catch {}
    }

    // 初始化
    loadSettings();
    updateLife(true);

    // 事件
    birthInput.addEventListener('change', () => { saveSettings(); updateLife(true); });
    expectInput.addEventListener('input', () => { saveSettings(); updateLife(true); });

    // 定期更新（當月進度變化很慢，1 分鐘更新一次足夠）
    const lifeTimer = setInterval(() => updateLife(false), 60 * 1000);
    window.addEventListener('beforeunload', () => clearInterval(lifeTimer));
  })();
  </script>
</body>
</html>